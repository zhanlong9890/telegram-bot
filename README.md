# Telegram 群管机器人

一个功能完善的 Telegram 群组管理机器人，支持踢人、禁言、警告等常用管理功能。

## 功能特性

### 🔨 管理功能
- ✅ 踢出用户 (`/ban`)
- ✅ 解封用户 (`/unban`)
- ✅ 禁言用户 (`/mute`)
- ✅ 解除禁言 (`/unmute`)
- ✅ 警告用户 (`/warn`) - 支持警告计数和自动踢出
- ✅ 清除警告 (`/unwarn`)
- ✅ 查看警告次数 (`/warns`)
- ✅ 删除消息 (`/del`)
- ✅ 查看用户信息 (`/info`)
- ✅ 权限检查（仅管理员可用）

### 💰 积分系统
- ✅ 自动积分奖励（发言获得积分）
- ✅ 查看自己的积分 (`/points`)
- ✅ 积分排行榜 (`/top`)
- ✅ 管理员添加积分 (`/addpoints`)
- ✅ 管理员扣除积分 (`/removepoints`)
- ✅ 管理员设置积分 (`/setpoints`)
- ✅ 防刷分机制（60秒冷却）
- ✅ 数据库存储（SQLite）

### 🤖 自动管理功能（新功能！）
- ✅ 自动删除广告（检测链接和关键词）
- ✅ 新成员欢迎消息（可自定义）
- ✅ 新成员加入奖励积分
- ✅ 可开关的自动功能

### ⚙️ 群组设置功能（新功能！）
- ✅ 自定义欢迎消息 (`/setwelcome`)
- ✅ 设置群规 (`/setrules`)
- ✅ 查看群组设置 (`/settings`)
- ✅ 开关自动功能

## 🚀 快速部署到云端（推荐）

### Railway 部署（最简单）

1. **准备代码**
   - 确保代码已推送到 GitHub

2. **注册 Railway**
   - 访问 [railway.app](https://railway.app)
   - 使用 GitHub 账号登录

3. **创建项目**
   - 点击 "New Project" → "Deploy from GitHub repo"
   - 选择你的代码仓库

4. **配置环境变量**
   - 在项目页面点击 "Variables"
   - 添加 `BOT_TOKEN=你的机器人Token`

5. **完成！**
   - Railway 会自动部署并运行机器人
   - 机器人将 24/7 运行，无需保持电脑开机

📚 **详细步骤**：查看 [部署步骤.md](./部署步骤.md)

### Webhook 模式（更高效）

如果你想使用 **Webhook 模式**（Telegram 主动推送更新，响应更快）：

1. **使用 `bot_webhook.py` 替代 `bot.py`**
2. **设置环境变量**：
   ```
   WEBHOOK_URL=https://你的域名.railway.app
   ```
3. **Railway 会自动使用 Webhook 模式**

📚 **详细说明**：查看 [Webhook说明.md](./Webhook说明.md) 和 [Webhook部署指南.md](./Webhook部署指南.md)

### 其他平台

- **Render**: 查看 [免费云端部署指南.md](./免费云端部署指南.md)
- **Fly.io**: 查看 [免费云端部署指南.md](./免费云端部署指南.md)

---

## 💻 本地安装步骤

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

复制 `env.example` 文件为 `.env`，并填入你的 Bot Token：

```bash
cp env.example .env
```

编辑 `.env` 文件：
```
BOT_TOKEN=你的机器人Token
ADMIN_IDS=管理员ID1,管理员ID2
```

**注意**：如果不创建 `.env` 文件，机器人会使用 `config.py` 中的默认 Token。

### 3. 运行机器人

**本地测试运行：**
```bash
python bot.py
```

**Windows 后台服务运行（24小时在线）：**
1. 下载 NSSM：https://nssm.cc/download
2. 解压到项目目录的 `nssm` 文件夹
3. 以管理员身份运行 `install_service.bat`

**云平台部署（推荐）：**
查看 [DEPLOY.md](DEPLOY.md) 了解详细部署步骤（Railway、Render、VPS等）

## 🤔 为什么别人的机器人一直在线？

**关键区别：**
- ❌ **本地运行**：电脑关机或程序关闭，机器人就停止
- ✅ **服务器部署**：部署在云服务器上，24小时运行

**解决方案：**
- 🚀 **推荐：Railway 免费部署**（最简单，完全免费）
- 💻 **Windows 服务**（电脑需一直开机）
- 🖥️ **VPS 服务器**（最稳定，需付费）

详细部署指南请查看：[DEPLOY.md](DEPLOY.md)

## 使用方法

### 将机器人添加到群组

1. 在 Telegram 中搜索你的机器人
2. 将机器人添加到群组
3. **重要**：给机器人管理员权限（至少需要"删除消息"和"限制成员"权限）

### 命令说明

#### 🔨 管理命令（仅管理员）

- **`/ban`** - 踢出用户（回复用户消息）
- **`/unban`** - 解封用户（回复用户消息）
- **`/mute [时间]`** - 禁言用户（回复用户消息，时间单位：秒）
- **`/unmute`** - 解除禁言（回复用户消息）
- **`/warn [原因]`** - 警告用户（回复用户消息，达到3次自动踢出）
- **`/unwarn`** - 清除用户所有警告（回复用户消息）
- **`/warns`** - 查看用户警告次数（回复用户消息）
- **`/del`** - 删除消息（回复消息）
- **`/info`** - 查看用户信息（回复用户消息）

#### 💰 积分命令

- **`/points`** - 查看自己的积分（或回复用户消息查看他人积分，需管理员）
- **`/top`** - 查看积分排行榜（前10名）

#### 🔧 积分管理（仅管理员）

- **`/addpoints <数量> [原因]`** - 给用户添加积分（回复用户消息）
- **`/removepoints <数量> [原因]`** - 扣除用户积分（回复用户消息）
- **`/setpoints <数量>`** - 设置用户积分（回复用户消息）

#### 💡 积分规则

- 在群组中发言自动获得积分（每条消息1分）
- 60秒内只能获得一次积分（防刷分）
- 积分数据存储在本地数据库（SQLite）
- 可以使用 `/top` 查看积分排行榜

#### 🤖 自动管理功能

- **自动删除广告**：自动检测并删除包含广告链接或关键词的消息
  - 检测 Telegram 邀请链接
  - 检测常见广告关键词
  - 自动扣除发送广告用户的积分
  - 使用 `/toggleads` 开关此功能

- **新成员欢迎**：新成员加入时自动发送欢迎消息
  - 使用 `/setwelcome` 设置自定义欢迎消息
  - 支持占位符：`{username}`, `{first_name}`, `{chat_title}`
  - 新成员自动获得10积分奖励
  - 使用 `/togglewelcome` 开关此功能

- **防刷屏**：自动检测并限制刷屏行为
  - 10秒内发送超过5条消息自动删除
  - 扣除积分惩罚
  - 发送警告消息

- **检测重复消息**：自动检测并删除重复消息
  - 检测用户发送的重复内容
  - 自动删除并扣除少量积分

#### ⚙️ 群组设置命令（仅管理员）

- **`/setwelcome <消息>`** - 设置欢迎消息
  - 示例：`/setwelcome 欢迎 {username} 加入！`
  
- **`/getwelcome`** - 查看当前欢迎消息

- **`/setrules <规则>`** - 设置群规
  - 示例：`/setrules 1. 禁止广告 2. 禁止刷屏`

- **`/rules`** - 查看群规（所有人可用）

- **`/settings`** - 查看所有群组设置

- **`/toggleads`** - 开关自动删除广告功能

- **`/togglewelcome`** - 开关欢迎消息功能

#### 📊 实用工具

- **`/id`** 或 **`/chatid`** - 获取用户ID和群组ID
- **`/groupinfo`** - 查看群组详细信息
- **`/admins`** - 查看管理员列表
- **`/stats`** - 查看群组统计（管理员）

## 权限要求

机器人需要以下权限才能正常工作：
- ✅ 删除消息
- ✅ 限制成员
- ✅ 封禁成员

## 项目结构

```
TG生态/
├── bot.py              # 主程序入口
├── config.py           # 配置文件
├── admin_commands.py   # 群管功能模块
├── points_system.py    # 积分系统模块
├── database.py         # 数据库模块（SQLite）
├── bot_data.db         # 数据库文件（自动生成）
├── requirements.txt    # 依赖包列表
├── env.example         # 环境变量示例
├── .gitignore         # Git 忽略文件
├── DEPLOY.md          # 部署指南（重要！）
├── install_service.bat # Windows 服务安装脚本
└── README.md          # 说明文档
```

## 部署到云平台（让机器人24小时运行）

### Railway 部署（推荐，免费）

1. 访问 https://railway.app 并注册
2. 创建新项目，连接 GitHub 仓库
3. 添加环境变量：`BOT_TOKEN`
4. 部署完成！机器人会自动运行

详细步骤请查看：[DEPLOY.md](DEPLOY.md)

## 注意事项

1. **安全性**：不要将 `.env` 文件提交到 Git 仓库
2. **权限**：确保机器人有足够的管理员权限
3. **日志**：所有操作都会记录在日志中
4. **错误处理**：如果命令执行失败，会显示错误信息

## 开发说明

### 添加新功能

1. 在 `admin_commands.py` 中添加新函数
2. 在 `bot.py` 中注册命令处理器
3. 更新 `README.md` 文档

### 日志

日志会输出到控制台，格式为：
```
时间 - 模块名 - 级别 - 消息内容
```

## 许可证

MIT License

## 支持

如有问题或建议，请提交 Issue。
